// backend/src/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUBSCRIBER
  CONTRIBUTOR
  AUTHOR
  EDITOR
  ADMINISTRATOR
  SUPER_ADMIN
}

enum PostStatus {
  DRAFT          // Initial draft (human or AI)
  AI_QUEUE       // Queued for AI generation
  AI_GENERATING  // Currently being generated by AI
  AI_REVIEW      // AI generated, awaiting admin review
  APPROVED_DRAFT // Admin approved, ready to schedule/publish
  SCHEDULED      // Scheduled for future publishing
  PUBLISHED      // Live and visible to public
  ARCHIVED       // Archived content
  REFRESH_QUEUE  // Queued for AI content refresh
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum NotificationCategory {
  ALERT
  CAMPAIGN
  GREETING
  UPDATE
}

enum NotificationChannel {
  IN_APP
  EMAIL
  BROWSER
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SYSTEM
  SECURITY
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationStatus {
  DRAFT
  SCHEDULED
  SENT
  ARCHIVED
}

enum NotificationAudience {
  ALL
  ROLE
  USER
}

model User {
  id       String @id @default(uuid())
  username String @unique // Unchangeable username
  email    String @unique
  password String // Hashed

  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  // User Profile Fields
  firstName   String?
  lastName    String?
  nickname    String?
  displayName String? // Can be: username, firstName, lastName, nickname, or email
  language    String  @default("en") // Language preference

  // Contact Info
  phoneNumber     String?
  countryCode     String?
  isPhoneVerified Boolean @default(false)
  isEmailVerified Boolean @default(false)
  emailVerifiedAt DateTime?
  website         String?
  facebook        String?
  twitter         String?
  instagram       String?
  linkedin        String?
  youtube         String?

  // System Fields
  role         Role     @default(SUBSCRIBER)
  capabilities Json? // Custom capabilities override
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  posts               Post[]
  comments            Comment[]
  emailChangeRequests EmailChangeRequest[]
  pages               Page[]
  media               Media[]
  notificationsCreated   Notification[]         @relation("NotificationCreator")
  notificationRecipients NotificationRecipient[]
  sessions               UserSession[]
  emailVerificationTokens EmailVerificationToken[]
}

model EmailChangeRequest {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  oldEmail String
  newEmail String

  // 8-digit hexadecimal verification codes
  oldEmailCode String
  newEmailCode String

  // Verification status
  oldEmailVerified Boolean @default(false)
  newEmailVerified Boolean @default(false)
  adminApproved    Boolean @default(false)

  // Timestamps
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  completedAt DateTime?

  @@index([userId])
}

model Category {
  id          String  @id @default(uuid())
  slug        String  @unique
  name        String
  description String?
  color       String? // Hex color for UI
  icon        String? // Icon name or emoji
  image       String? // Category image URL
  posts       Post[]

  // Hierarchical categories (parent-child)
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")

  // SEO for category pages
  seoTitle       String?
  seoDescription String?

  // Display order
  order    Int     @default(0)
  featured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([order, featured])
}

model Tag {
  id          String  @id @default(uuid())
  slug        String  @unique
  name        String
  description String?
  color       String? // Hex color for UI
  icon        String? // Icon name or emoji
  posts       Post[]

  // Tag Analytics
  usageCount Int     @default(0)
  trending   Boolean @default(false)
  featured   Boolean @default(false)
  mergeCount Int     @default(0)
  synonymHits Int    @default(0)
  synonyms   String[] @default([]) // Alias terms that map to this tag
  linkedTagIds String[] @default([]) // Companion tags to auto-attach
  locked     Boolean @default(false) // Prevent deletion/rename without admin

  // Multilingual Support
  language     String?  @default("en") // ISO 639-1 code: en, ar, hi, es, fr, de, etc.
  translations Json?   // {"ar": {"name": "...", "description": "..."}, "hi": {...}}
  isMultilingual Boolean @default(false) // True if tag has translations

  // Hierarchical tags (parent-child relationships)
  parentId String?
  parent   Tag?    @relation("TagHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Tag[]   @relation("TagHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([trending, usageCount])
}

model Post {
  id             String     @id @default(uuid())
  slug           String     @unique
  title          String
  content        String     @db.Text // HTML or Markdown
  excerpt        String?
  featuredImage  String? // URL to featured image
  status         PostStatus @default(DRAFT)
  publishedAt    DateTime?
  scheduledFor   DateTime? // For scheduled publishing
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[] // Array of SEO keywords

  // Multilingual & Localization
  language     String  @default("en") // Primary language: en, ar, hi, es, fr, de, etc.
  translations Json?  // Multilingual versions: {"ar": {"title": "...", "content": "...", "excerpt": "..."}, "hi": {...}}
  region       String? // Geographic targeting: UAE, US, IN, UK, etc.
  
  // Social Media Meta Tags
  ogTitle       String?
  ogDescription String?
  ogImage       String?
  twitterCard   String? // summary, summary_large_image, etc.

  // Analytics & Metrics
  viewCount   Int  @default(0)
  readingTime Int? // in minutes
  wordCount   Int  @default(0) // Actual word count (min 3000 for new posts)

  authorId   String
  author     User       @relation(fields: [authorId], references: [id])
  categories Category[]
  tags       Tag[]

  // AI Features & Workflow
  aiMetadata     Json?    // Storage for AI metadata (keywords, generation params, model version)
  aiGenerated    Boolean  @default(false) // Track if AI-generated or manual
  aiModel        String?  // AI model used (gpt-4, claude, etc.)
  aiPrompt       String?  @db.Text // Original prompt used for generation
  autoTags       String[] // Auto-generated tags from content
  relatedPostIds String[] // IDs of related posts for interlinking
  
  // AI Generation Workflow
  generationAttempts Int      @default(0) // Number of AI generation attempts
  lastGeneratedAt    DateTime? // Last time content was AI generated
  reviewedBy         String?  // Admin who reviewed AI content
  reviewedAt         DateTime? // When admin reviewed
  reviewNotes        String?  @db.Text // Admin notes on AI content
  
  // Content Refresh System
  lastRefreshedAt    DateTime? // Last time content was refreshed
  needsRefresh       Boolean  @default(false) // Flag for old content needing update
  refreshReason      String?  // Why refresh is needed (outdated, trending keywords, etc.)
  contentAge         Int      @default(0) // Days since last major update

  allowComments Boolean        @default(true)
  interlinks    Json? // Automated internal links with context
  internalLinks InternalLink[] // Structured internal links
  comments      Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, publishedAt])
  @@index([authorId])
  @@index([slug])
}

model Comment {
  id        String   @id @default(uuid())
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  editedAt  DateTime?
  editedBy  String?

  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // For non-registered commenters
  authorName    String?
  authorEmail   String?
  authorWebsite String?

  // Moderation & Status
  isApproved Boolean @default(false) // Changed to false for moderation
  isSpam     Boolean @default(false)
  isFlagged  Boolean @default(false)
  flagReason String?
  isPinned   Boolean @default(false)
  isResolved Boolean @default(false)
  staffNote  String?

  // Nested Comments (threading)
  parentId String?
  parent   Comment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentThread")

  // IP tracking for spam prevention
  ipAddress String?
  userAgent String?

  // Admin actions
  moderatedBy String?
  moderatedAt DateTime?

  // Engagement
  upvotes  Int   @default(0)
  downvotes Int  @default(0)
  reactions Json?

  @@index([postId, isApproved])
  @@index([userId])
  @@index([parentId])
}

model Notification {
  id          String @id @default(uuid())
  title       String
  message     String @db.Text
  category    NotificationCategory @default(ALERT)
  type        NotificationType @default(INFO)
  priority    NotificationPriority @default(NORMAL)
  status      NotificationStatus @default(DRAFT)
  audience    NotificationAudience @default(ALL)
  channels    NotificationChannel[] @default([IN_APP])
  targetRoles Role[] @default([])
  targetUserIds String[] @default([])
  actionLabel String?
  actionUrl   String?
  isSticky    Boolean @default(false)
  sendAt      DateTime?
  expiresAt   DateTime?

  createdById String
  createdBy   User @relation("NotificationCreator", fields: [createdById], references: [id])

  recipients  NotificationRecipient[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, sendAt])
  @@index([audience])
  @@index([type, priority])
  @@index([category])
}

model NotificationRecipient {
  id             String @id @default(uuid())
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  userId         String
  user           User @relation(fields: [userId], references: [id], onDelete: Cascade)

  deliveredAt DateTime?
  readAt      DateTime?
  dismissedAt DateTime?
  archivedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([notificationId, userId])
  @@index([userId, readAt])
  @@index([notificationId])
}

model UserSession {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokenHash String  @unique
  userAgent       String?
  ipAddress       String?
  createdAt       DateTime @default(now())
  lastUsedAt      DateTime?
  revokedAt       DateTime?
  expiresAt       DateTime

  @@index([userId, revokedAt])
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique
  codeHash  String?
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId, expiresAt])
}

// Internal Link Management for SEO
model InternalLink {
  id            String  @id @default(uuid())
  sourcePostId  String
  sourcePost    Post    @relation(fields: [sourcePostId], references: [id], onDelete: Cascade)
  targetUrl     String
  anchorText    String
  context       String? // Surrounding text for context
  autoGenerated Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([sourcePostId])
}

model SiteSettings {
  id                 String   @id @default(uuid())
  siteName           String   @default("My Awesome Blog")
  description        String?
  footerText         String?
  seoKeywords        String?
  socialLinks        Json?
  aiConfig           Json?
  logo               String? // URL to site logo
  favicon            String? // URL to favicon
  darkMode           Boolean  @default(false) // Default dark mode preference

  captchaType           String   @default("recaptcha-v2") // 'recaptcha-v2', 'recaptcha-v3', 'custom'
  recaptchaV2SiteKey    String?
  recaptchaV2SecretKey  String?
  recaptchaV3SiteKey    String?
  recaptchaV3SecretKey  String?

  recaptchaSiteKey   String?
  recaptchaSecretKey String?
  forceHttps         Boolean  @default(false)
  homePageLayout     String   @default("single") // "single" or "dual"
  homePageId         String?  // Reference to Page for homepage
  blogPageId         String?  // Reference to Page for blog listing
  topBarEnabled      Boolean  @default(false) // Enable/disable top bar
  contactInfo        Json?    // Owner contact info and social media: { phone, email, address, facebook, twitter, instagram, linkedin, youtube }
  menuStructure      Json?    // Site menu structure: { menus: [{ name, items: [{ type, label, url, pageId, postId }] }] }
  widgetConfig       Json?    // Sidebar widget configuration: { widgets: [{ type, enabled, settings }] }
  appearanceSettings Json?    // Color scheme, fonts, typography: { colors: { primary, secondary }, fonts: { heading, body }, typography: { ... } }
  cookieConsentEnabled Boolean @default(true)
  cookieConsentConfig Json?
  notificationConfig Json?
  sitemapConfig      Json?
  
  // Site Ownership Verification (META TAG CONTENT ONLY - not full HTML tags)
  googleSiteVerification String? // Google Search Console: content="..." value only
  bingSiteVerification   String? // Bing Webmaster: content="..." value only
  yandexSiteVerification String? // Yandex Webmaster: content="..." value only
  pinterestVerification  String? // Pinterest: content="..." value only
  facebookDomainVerification String? // Facebook: content="..." value only
  customVerificationTag  String? // Generic verification for any other platform: full meta tag HTML
  
  // Verification File Upload Method (JSON)
  verificationFiles Json? // Store verification file info: { "google": {"filename": "google123.html", "content": "...", "uploadedAt": "..." } }
  
  // AI Blog Generation Settings
  aiEnabled              Boolean @default(true) // Master switch for AI features
  aiProvider             String  @default("openai") // openai, anthropic, custom
  aiModel                String  @default("gpt-4") // Model to use
  aiBatchSize            Int     @default(10) // Number of posts to generate per batch
  aiMinWordCount         Int     @default(3000) // Minimum words per AI post
  aiMaxWordCount         Int     @default(5000) // Maximum words per AI post
  aiAutoApprove          Boolean @default(false) // Auto-approve AI posts (dangerous!)
  aiGenerationSchedule   String  @default("0 2 * * *") // Cron: Daily at 2 AM
  aiMode                 String  @default("standard") // standard, go, god
  aiLearningLevel        Int     @default(3) // 1-7 depth
  aiSelfLearningEnabled  Boolean @default(false)
  
  // Content Strategy
  siteKeywords           String[] @default([]) // Core keywords for AI content
  targetAudience         String?  // Description of target audience
  contentTone            String   @default("professional") // professional, casual, technical
  contentFocus           String?  // Main topic/niche of the site
  
  // Auto-Tagging Settings
  autoTaggingEnabled     Boolean @default(true) // Auto-generate tags from content
  minTagsPerPost         Int     @default(3) // Minimum tags required
  maxTagsPerPost         Int     @default(10) // Maximum tags allowed
  
  // Interlinking Settings
  autoInterlinkEnabled   Boolean @default(true) // Auto-create internal links
  minInterlinksPerPost   Int     @default(3) // Minimum internal links per post
  maxInterlinksPerPost   Int     @default(8) // Maximum internal links per post
  interlinkingSchedule   String  @default("0 3 * * *") // Cron: Daily at 3 AM
  
  // Content Refresh Settings
  contentRefreshEnabled  Boolean @default(true) // Auto-refresh old content
  refreshAfterDays       Int     @default(180) // Refresh content older than X days
  refreshCheckSchedule   String  @default("0 4 * * 0") // Cron: Weekly on Sunday at 4 AM
  
  updatedAt              DateTime @updatedAt
}

model ContactMessage {
  id        String   @id @default(uuid())
  name      String
  email     String
  subject   String?
  message   String
  createdAt DateTime @default(now())
  read      Boolean  @default(false)
}

// THE QUEUE SYSTEM
model QueueJob {
  id      String    @id @default(uuid())
  type    String // e.g. "GENERATE_POST", "TRANSLATE", "SEO_OPTIMIZE"
  payload Json // Input data for the job
  result  Json? // Output data from AI
  status  JobStatus @default(PENDING)
  error   String?

  attempts    Int       @default(0)
  lockedAt    DateTime?
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([status, createdAt])
}

// PAGE BUILDER SYSTEM - Single Source of Truth for all Pages
enum PageStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

enum PageType {
  STATIC // Regular static pages
  DYNAMIC // Pages with dynamic data
  TEMPLATE // Reusable templates
  HOMEPAGE // Homepage
  LANDING // Landing pages
}

model Page {
  id          String  @id @default(uuid())
  title       String
  slug        String  @unique
  description String?

  // Page Type & Status
  pageType       PageType   @default(STATIC)
  status         PageStatus @default(DRAFT)
  usePageBuilder Boolean    @default(true)
  isPolicyPage   Boolean    @default(false)

  // Content Structure (JSON-based page builder)
  content   Json // Structured page content with sections/components
  customCss String? @db.Text
  customJs  String? @db.Text

  // Layout & Design
  layout     String  @default("default") // Layout template to use
  headerType String? // Custom header type (default, transparent, sticky, none)
  footerType String? // Custom footer type (default, minimal, none)

  // SEO & Meta
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[]
  ogImage        String?
  metaTags       Json? // Additional meta tags

  // Responsive Settings
  mobileContent Json? // Mobile-specific overrides
  tabletContent Json? // Tablet-specific overrides

  // Advanced Features
  parentId String? // For page hierarchy
  parent   Page?   @relation("PageHierarchy", fields: [parentId], references: [id])
  children Page[]  @relation("PageHierarchy")

  // Access Control
  isProtected  Boolean @default(false)
  allowedRoles Role[]

  // Publishing
  publishedAt  DateTime?
  scheduledFor DateTime?
  expiresAt    DateTime?

  // Versioning
  versions         PageVersion[]
  currentVersionId String?

  // Template Management
  isTemplate       Boolean @default(false)
  templateName     String?
  templateCategory String?

  // Analytics & Behavior
  viewCount      Int     @default(0)
  enableComments Boolean @default(false)
  enableSharing  Boolean @default(true)

  // Author & Timestamps
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status, publishedAt])
  @@index([pageType])
  @@index([authorId])
}

// Page Version Control - Keep history of all changes
model PageVersion {
  id     String @id @default(uuid())
  pageId String
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  versionNumber Int
  title         String
  content       Json
  customCss     String? @db.Text
  customJs      String? @db.Text

  // Change tracking
  changeNote  String?
  createdById String
  createdAt   DateTime @default(now())

  @@unique([pageId, versionNumber])
  @@index([pageId])
}

// Reusable Page Components/Sections
model PageComponent {
  id       String @id @default(uuid())
  name     String
  type     String // section, widget, element, block
  category String // hero, features, testimonials, etc.

  // Component Structure
  content   Json // Component configuration and content
  thumbnail String? // Preview image

  // Metadata
  description String?
  tags        String[]
  isGlobal    Boolean  @default(false) // Can be reused across pages
  isPremium   Boolean  @default(false)

  // Usage tracking
  usageCount Int @default(0)

  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type, category])
  @@index([isGlobal])
}

// Page Templates - Pre-built page designs
model PageTemplate {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String?

  // Template Design
  thumbnail String?
  preview   String? // Preview URL or image
  content   Json // Full page structure
  category  String // business, portfolio, ecommerce, blog, etc.

  // Features
  tags      String[]
  isPremium Boolean  @default(false)
  isActive  Boolean  @default(true)

  // Stats
  usageCount Int    @default(0)
  rating     Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
}

// Global Site Sections (Header, Footer, Sidebars)
model GlobalSection {
  id   String @id @default(uuid())
  name String @unique
  type String // header, footer, sidebar, popup

  content   Json // Section structure
  customCss String? @db.Text
  customJs  String? @db.Text

  isActive  Boolean  @default(true)
  appliesTo String[] // ['all', 'pages', 'posts', 'specific-page-ids']

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
}

// Media Library for Page Builder
model Media {
  id           String @id @default(uuid())
  filename     String
  originalName String
  mimeType     String
  size         Int // bytes

  // File location
  url  String
  path String

  // Image specific
  width   Int?
  height  Int?
  altText String?

  // Metadata
  title       String?
  description String?
  tags        String[]
  folder      String?  @default("uploads")

  // Optimization
  isOptimized Boolean @default(false)
  variants    Json? // Different sizes/formats

  uploadedById String
  uploadedBy   User   @relation(fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mimeType])
  @@index([folder])
  @@index([uploadedById])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  method    String
  url       String
  statusCode Int
  ip        String?
  userAgent String?
  duration  Int
  createdAt DateTime @default(now())
}
